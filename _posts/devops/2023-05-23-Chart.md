---
layout: post
current: post
cover: assets/built/images/background/helm.svg
navigation: True
title: The Chart Repository in AWS
date: 2023-05-23 00:00:00
tags: [devops, aws]
class: post-template
subclass: 'post tag-aws'
author: HeuristicWave
---
AWSì—ì„œ Helm chart repositoriesë¥¼ ìš´ì˜í•˜ëŠ” ë°©ë²•

## Intro

AWS í™˜ê²½ì—ì„œ EKSë¥¼ í™œìš©í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ìš´ì˜í•˜ë‹¤ ë³´ë©´, manifest íŒŒì¼ë“¤ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ helmì„ ì‚¬ìš©í•˜ê²Œ ë©ë‹ˆë‹¤.
ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œëŠ” Helm chartì— ëŒ€í•˜ì—¬ ì•Œì•„ë³´ê³  AWS í™˜ê²½ì—ì„œ Helm chartë¥¼ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì— ëŒ€í•˜ì—¬ ì´ì•¼ê¸°í•´ ë³´ê² ìŠµë‹ˆë‹¤.

## ğŸï¸ Background knowledge

**Helm**ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ë¥¼ ìœ„í•œ íŒ¨í‚¤ì§€ ê´€ë¦¬ ë„êµ¬ì…ë‹ˆë‹¤. **Chart**ë¼ëŠ” íŒŒì¼ í˜•ì‹ìœ¼ë¡œ íŒ¨í‚¤ì§• í•˜ë©°, ì°¨íŠ¸ë¥¼ í†µí•´ ì„¤ì¹˜, ì—…ê·¸ë ˆì´ë“œ ë¡¤ë°±ì„ ê°„í¸í•˜ê²Œ í•´ì¤ë‹ˆë‹¤.
**Repository**ëŠ” ì°¨íŠ¸ë¥¼ ëª¨ìœ¼ê³  ê³µìœ í•  ìˆ˜ ìˆëŠ” ê³³ìœ¼ë¡œ, í•˜ë‚˜ì˜ ì €ì¥ì†Œì—ì„œ ì—¬ëŸ¬ ê°œì˜ Chartë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê³µì‹ ì°¨íŠ¸ ì €ì¥ì†Œ [ArtifactHUB](https://artifacthub.io/ )ë¥¼ í™œìš©í•  ìˆ˜ë„ ìˆê³ , ë‹¤ìŒê³¼ ê°™ì´ ìì‹ ë§Œì˜ ì°¨íŠ¸ë¥¼ ë§Œë“¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

- Local í™œìš© (*`helm repo index {PATH}`, ë¡œì»¬ì„ backendë¡œ `index.yaml` íŒŒì¼ì´ ìƒì„±*)
- [GitHub Pagesë¥¼ í™œìš©í•œ Public Helm Chart êµ¬ì¶•](https://medium.com/@mattiaperi/create-a-public-helm-chart-repository-with-github-pages-49b180dbb417) 
- [GitHubì—ì„œ Private Helm chart ì €ì¥ì†Œ ì„¤ì •](https://jasiek-petryk.medium.com/setting-up-a-private-helm-chart-repository-on-github-4a767703cec8)

ì°¸ê³  : [The Chart Repository Guide](https://helm.sh/docs/topics/chart_repository/)

# Amazon S3ë¡œ Helm Repository êµ¬ì¶•í•˜ê¸°

Helmì„ íŒ¨í‚¤ì§• í•˜ë©´ `tgz` í˜•ì‹ì˜ ì•„ì¹´ì´ë¸Œ íŒŒì¼ì´ ìƒì„±ë˜ë©°, ì´ëŸ° ì°¨íŠ¸ íŒŒì¼ì€ ì£¼ë¡œ Amazon S3ì™€ ê°™ì€ Object storageë¥¼ ë°±ì—”ë“œë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
AWS í™˜ê²½ì—ì„œ S3ë¥¼ ì‚¬ìš©í•´ Chartë¥¼ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì— ëŒ€í•˜ì—¬ ë‹¤ìŒ 2ê°€ì§€ ë°©ë²•ìœ¼ë¡œ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

- Helm Projectì—ì„œ ê´€ë¦¬ë˜ëŠ” [ChartMuseum](https://chartmuseum.com/)
- AWS Prescriptive Guidance, [Set up a Helm v3 chart repository in Amazon S3](https://docs.aws.amazon.com/prescriptive-guidance/latest/patterns/set-up-a-helm-v3-chart-repository-in-amazon-s3.html )ì— ì†Œê°œëœ [helm-s3](https://github.com/hypnoglow/helm-s3)

## ğŸ›ï¸ ChartMuseum using Amazon S3

ChartMuseumì€ Amazon ì™¸ì—ë„ DigitalOcean, Google Cloud, Microsoft Azure ë“± ë‹¤ì–‘í•œ Storageë¥¼ ë°±ì—”ë“œë¡œ ì§€ì›í•©ë‹ˆë‹¤.

### Architecture

Helm Clientì˜ ê²½ìš° AWS Cloud ë‚´ **EC2 ì¸ìŠ¤í„´ìŠ¤** í˜¹ì€ ê°œë°œìì˜ **Local ì‘ì—… í™˜ê²½** ëª¨ë‘ ê°€ëŠ¥í•©ë‹ˆë‹¤.

![chartmuseum](../../assets/built/images/post/architecture/chartmuseum.png)

### Process

**1. ì¤€ë¹„ ì‘ì—…**

- [Installation](https://chartmuseum.com/docs/#installation )ì„ ì°¸ê³ í•˜ì—¬ `GoFish` í˜¹ì€ `curl`ë¡œ ì„¤ì¹˜
- í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ `mychart`ë¼ëŠ” ì„ì˜ì˜ ì°¨íŠ¸ ìƒì„± : `helm create mychart`
- helm repositoryì— ë‹´ì„ ì°¨íŠ¸ë¥¼ íŒ¨í‚¤ì§€í™” : `helm package ./mychart`

**2. Chartmuseum ì‹¤í–‰ ë° Repository ì¶”ê°€**

- [Using with Amazon S3](https://chartmuseum.com/docs/#using-amazon-s3 )ì— ê¸°ì¬ëœ ëŒ€ë¡œ, `endpoint`ë¥¼ ì„¤ì •í•˜ê³  `IAM` ê¶Œí•œì„ ë¶€ì—¬
- ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ chartmuseumì„ ì‹¤í–‰ì‹œí‚¤ê³  Helm Clientì˜ URLì— ì ‘ì†í•˜ì—¬ ë™ì‘ ì—¬ë¶€ í™•ì¸ <br> *Helm Clientê°€ localì¸ ê²½ìš°, `http://localhost:8080`ì—ì„œ í™•ì¸ ê°€ëŠ¥*
  ```shell
  chartmuseum --debug --port=8080 \
  --storage="amazon" \
  --storage-amazon-bucket="my-s3-bucket" \
  --storage-amazon-prefix="" \
  --storage-amazon-region="us-east-1"
  ```
- ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ repositoryë¥¼ ì¶”ê°€ : `helm repo add my-chart http://localhost:8080` <br> *`helm repo ls` ëª…ë ¹ì–´ë¡œ í™•ì¸ ê°€ëŠ¥*

**3. S3ì— íŒ¨í‚¤ì§€ ì—…ë¡œë“œ**

- ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ `helm plugin install https://github.com/chartmuseum/helm-push` <br>
[helm-push](https://github.com/chartmuseum/helm-push) í”ŒëŸ¬ê·¸ì¸ì„ ë‹¤ìš´ë¡œë“œí•˜ê³ , `helm cm-push --help` ëª…ë ¹ì–´ë¡œ ì„¤ì¹˜ ì—¬ë¶€ í™•ì¸
- `cm-push` ëª…ë ¹ì–´ë¡œ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ : `helm cm-push mychart/ my-chart`
- ì •ìƒì ìœ¼ë¡œ íŒ¨í‚¤ì§€ê°€ ì˜¬ë¼ê°€ë©´ ì•„ë˜ì™€ ê°™ì´ S3 ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥
  ![s3-chart.png](../../assets/built/images/post/aws/chartmuseum-s3.png)

## â˜ï¸ Helm v3 chart repository using helm-s3

ì´ë²ˆì—ëŠ” [AWS ê³µì‹ ë¬¸ì„œ](https://docs.aws.amazon.com/ko_kr/prescriptive-guidance/latest/patterns/set-up-a-helm-v3-chart-repository-in-amazon-s3.html )ì— ì†Œê°œ **helm-s3** í”ŒëŸ¬ê·¸ì¸ì„ ì‚¬ìš©í•´ AWS Native í•˜ê²Œ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

### Architecture

ë¬¸ì„œì—ì„œëŠ” AWS Native í•˜ê²Œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•˜ê¸° ìœ„í•´, ë¡œì»¬ helm ì½”ë“œë¥¼ ìš´ì˜í•˜ê¸° ìœ„í•´ **CodeCommit**ê³¼, Helm Clientë¡œ **EC2 ì¸ìŠ¤í„´ìŠ¤**ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.
ChartMuseum êµ¬ì¶• ë•Œì™€ ë§ˆì°¬ê°€ì§€ë¡œ Helm Clientë¥¼ ê°œë°œìì˜ **Local ì‘ì—… í™˜ê²½** í˜¹ì€ CodeCommitì„ ë‹¤ë¥¸ í˜•ìƒê´€ë¦¬ ë„êµ¬ë¡œ ëŒ€ì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

![helm-s3](https://docs.aws.amazon.com/images/prescriptive-guidance/latest/patterns/images/pattern-img/1dbd3db8-5819-4f30-bebd-a144a2075fcd/images/55652eb2-2e11-4b14-9ed4-0cdcf55cc3e6.png)

> ğŸ§ í•´ë‹¹ ë°©ì‹ì—ì„œëŠ” **Source code management** ëª©ì ìœ¼ë¡œ CodeCommitì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. <br>
> ì¦‰, **ì†ŒìŠ¤ ì½”ë“œ ë° ë¦¬ì†ŒìŠ¤ì˜ ë²„ì „ ê´€ë¦¬**ë¡œ CodeCommitì„ ì‚¬ìš©í•˜ê³  **ì°¨íŠ¸ íŒŒì¼ì˜ ì €ì¥ê³¼ ë°°í¬**ì— S3ì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤. <br>

> â—ï¸ CodeCommitì„ ì†ŒìŠ¤ ì½”ë“œ ë²„ì „ ê´€ë¦¬ ëª©ì  ì™¸ì—ë„ ArgoCDì™€ í†µí•©í•˜ì—¬ ë°°í¬ì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br>
> [AWS Workshop](https://catalog.us-east-1.prod.workshops.aws/workshops/9c0aa9ab-90a9-44a6-abe1-8dff360ae428/ko-KR/110-cicd/110-cicd )ì˜ Helm Repoë¡œ CodeCommitì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ë„ ìˆìœ¼ë‹ˆ ì°¸ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

### Process

**1. ì¤€ë¹„ ì‘ì—…**

- ê³ ìœ í•œ S3 ë²„í‚· ìƒì„± í›„, ë²„í‚·ì—ì„œ `stable/myapp` í´ë”ë¥¼ ìƒì„± 
- helm-s3 í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜ :  `helm plugin install https://github.com/hypnoglow/helm-s3.git`

**2. S3 ë²„í‚· ì´ˆê¸°í™” ë° ì¶”ê°€**

- S3 í´ë”ë¥¼ Helm Repositoryë¡œ ì´ˆê¸°í™” : `helm s3 init s3://{YOUR_BUCKET}/stable/myapp`
- `index.yaml` íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸ : `aws s3 ls s3://{YOUR_BUCKET}/stable/myapp`
- Helm í´ë¼ì´ì–¸íŠ¸ì— Repository ì¶”ê°€ : `helm repo add stable-myapp s3://{YOUR_BUCKET}/stable/myapp/`
- Repository í™•ì¸ : `helm repo ls`

**3. S3ì— íŒ¨í‚¤ì§€ ì—…ë¡œë“œ**

- ChartMuseum êµ¬ì¶•ì—ì„œ ì‚¬ìš©í•œ `mychart-*.tgz` íŒŒì¼ í™œìš©
- `s3 push` ëª…ë ¹ì–´ë¡œ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ : `helm s3 push ./mychart-0.1.0.tgz stable-myapp`
- ì •ìƒì ìœ¼ë¡œ íŒ¨í‚¤ì§€ê°€ ì˜¬ë¼ê°€ë©´ `index.yaml`ì— ì—…ë¡œë“œ ì •ë³´ê°€ ê°±ì‹ ë˜ë©°, ë‹¤ìŒê³¼ ê°™ì´ S3ì—ì„œ í™•ì¸ ê°€ëŠ¥
  ![helm-s3.png](../../assets/built/images/post/aws/helm-s3.png)
  
<br>

## Outro

ì²« ë²ˆì§¸ ë°©ë²•ì—ì„œëŠ”, ChartMuseumì„ ì‹¤í–‰ì‹œí‚¤ê³  `helm-push` í”ŒëŸ¬ê·¸ì¸ì„ í™œìš©í•˜ì—¬ ì°¨íŠ¸ë¥¼ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤.
ë°˜ë©´ ë‘ ë²ˆì§¸ ë°©ë²•ì—ì„œëŠ” ChartMuseumê³¼ ê°™ì€ ì—…ë¡œë“œ ê³„ì¸µ ì—†ì´, `helm-s3` í”ŒëŸ¬ê·¸ì¸ì„ í™œìš©í•˜ì—¬ Directë¡œ ì°¨íŠ¸ë¥¼ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤.

`helm-s3` ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ ChartMuseumê³¼ ê°™ì€ Layerê°€ ì—†ì–´ ì‚¬ìš©ì´ í¸ë¦¬í•©ë‹ˆë‹¤.
ê·¸ë¿ë§Œ ì•„ë‹ˆë¼ ì—¬ëŸ¬ ê°œì˜ Chartë¥¼ ìš´ìš©í•˜ëŠ” ê²½ìš°, ChartMuseumì€ `--storage-amazon-prefix` ì˜µì…˜ì„ ë°”ê¿”ê°€ë©° ì‹¤í–‰í•´ì•¼ í•˜ì§€ë§Œ,
`helm-s3`ëŠ” `helm repo add` ëª…ë ¹ì–´ ë’¤ì— **prefix**ë§Œ ë°”ê¿” ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ í›¨ì”¬ ìœ ìš©í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤.
GCPë‚˜ Azureì™€ ê°™ì€ ë‹¤ë¥¸ Object Storageë¥¼ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ê²Œ ì•„ë‹ˆë¼ë©´, `helm-s3`ë¡œ êµ¬ì¶•í•˜ëŠ” ê²ƒì´ ì¢‹ê² ë„¤ìš”.

ì†Œì¤‘í•œ ì‹œê°„ì„ ë‚´ì–´ ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ì˜ëª»ëœ ë‚´ìš©ì€ ì§€ì í•´ ì£¼ì„¸ìš”! ğŸ˜ƒ

---
