---
layout: post
current: post
cover: assets/built/images/background/packer&terraform.png
navigation: True
title: Provision Infrastructure with Packer
date: 2021-08-02 00:00:00
tags: [devops, aws]
class: post-template
subclass: 'post tag-devops'
author: HeuristicWave
---

ë³¸ ê¸€ì€ [HashiCorp Learn - Provision Infrastructure with Packer](https://learn.hashicorp.com/tutorials/terraform/packer )ì—ì„œ ë‹¤ë£¨ëŠ” ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±í•œ ê¸€ ì…ë‹ˆë‹¤.

<br>

> Packerë¥¼ ì‚¬ìš©í•´ AWS AMIë¥¼ ë§Œë“¤ê³  Terraformê³¼ ì—°ê³„í•˜ì—¬ í™œìš©í•˜ëŠ” ë°©ë²•ì— ì•½ê°„ì˜ ì„¤ëª…ê³¼ íŒì„ ë‹´ì•„ í•œêµ­ì–´ë¡œ ì¬ì‘ì„±í•´ ë³´ì•˜ìŠµë‹ˆë‹¤. (ì„¤ì¹˜ì™€ ê´€ë ¨ëœ ì¤€ë¹„ì‚¬í•­ì€ ìƒëµë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì›ë¬¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”.)

<br>

## í”„ë¡œì íŠ¸ êµ¬ì¡°

ë¨¼ì €, í•´ë‹¹ íŠœí† ë¦¬ì–¼ì„ ì§„í–‰í•˜ê¸° ìœ„í•œ í”„ë¡œì íŠ¸ êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤. ì•„ë˜ì™€ í´ë”ì™€ íŒŒì¼ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”.

```shell
.
â””â”€â”€ provision-infra-with-packer
    â”œâ”€â”€ images
    â”‚   â””â”€â”€ image.pkr.hcl
    â”œâ”€â”€ instances
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â””â”€â”€ variables.tf
    â””â”€â”€ scripts
        â””â”€â”€ setup.sh
```

<br>

## Local SSH key ìƒì„±í•˜ê¸°

`provision-infra-with-packer` í´ë” ì•ˆì—ì„œ AWS AMIë¡œ ë§Œë“¤ ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†í•˜ê¸° ìœ„í•œ SSH í‚¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
í•„ìëŠ” ì‚¬ìš©í•  ê³µê°œí‚¤ë¥¼ Mac OSì—ì„œ `ssh-keygen`ìœ¼ë¡œ ìƒì„±í•˜ì˜€ìŠµë‹ˆë‹¤. ê°ì í™˜ê²½ì— ë§ëŠ” ë°©ë²•ìœ¼ë¡œ SSH ê³µê°œí‚¤ë¥¼ ìƒì„±í•˜ì„¸ìš”.
ì•”í˜¸í™” íƒ€ì…(`-t`)ì„ RSAë¡œ ì£¼ì„(`-C`)ì„ ì´ë©”ì¼ë¡œ ìƒì„±ë˜ëŠ” ê³µê°œí‚¤ì˜ ìœ„ì¹˜(`-f`)ë¥¼ í˜„ì¬ directoryë¡œ ì„¤ì •í•˜ê³  ê³µê°œí‚¤ì˜ ì´ë¦„ì„ `tf-packer`ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.
ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ ë˜ì§€ë§Œ í¸ì˜ìƒ ê³µë°±ìœ¼ë¡œ ë‘ê² ìŠµë‹ˆë‹¤.

```shell
$ ssh-keygen -t rsa -C "your_email@example.com" -f ./tf-packer
```

ì´í›„ `tf-packer`ì™€ `tf-packer.pub` 2ê°€ì§€ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆë‹¤ë©´ ë‹¤ìŒ ë‹¨ê³„ ğŸš€

<br>

## Packer ì½”ë“œ ì‘ì„±í•˜ê¸°

*`image.pkr.hcl` íŒŒì¼ì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤.* <br>

### 1ï¸âƒ£ AMI êµ¬ì¶•ì— í•„ìš”í•œ config ì‘ì„±

packerê°€ ë¹Œë“œí•œ ì´ë¯¸ì§€ê°€ ì €ì¥ë  ë¦¬ì „ì˜ ì •ë³´ì™€ AMIì— timestamp ì •ë³´ë¥¼ ë„£ê¸° ìœ„í•œ configë¥¼ ì°¨ë¡€ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

```shell
variable "region" {
  type    = string
  default = "us-east-1"
}

locals { timestamp = regex_replace(timestamp(), "[- TZ:]", "") }
```

### 2ï¸âƒ£ï¸ Base AMIì— ëŒ€í•œ Source AMI config ì‘ì„±

packerê°€ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©ë˜ëŠ” Base AMIì— ëŒ€í•œ ì •ë³´ë¥¼ `source` ë¸”ë¡ì— ì •ì˜í•©ë‹ˆë‹¤.
1ë‹¨ê³„ì—ì„œ ì‘ì„±í•œ config ê°’ì„ í™œìš©í•´ ë¦¬ì „ê³¼ timestampë¥¼ ë„£ì–´ì£¼ëŠ” ì½”ë“œì™€ Packer Builderë¡œ ì‚¬ìš©í•  **ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì„ ì§€ì •**í•©ë‹ˆë‹¤.
ì´í›„, AWSì— ì¡´ì¬í•˜ëŠ” ìˆ˜ë§ì€ AMI ì¤‘ì—ì„œ sourceë¡œ í™œìš©í•  ì´ë¯¸ì§€ë¥¼ **filter** ì½”ë“œë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
(`name` ë¶€ë¶„ì— ì§ì ‘ ami ë²ˆí˜¸ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ê¸°ì¬ í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.)

```shell
source "amazon-ebs" "example" {
  ami_name      = "learn-terraform-packer-${local.timestamp}"
  instance_type = "t2.micro"
  region        = var.region
  source_ami_filter {
    filters = {
      name                = "ubuntu/images/*ubuntu-xenial-16.04-amd64-server-*"
      root-device-type    = "ebs"
      virtualization-type = "hvm"
    }
    most_recent = true
    owners      = ["099720109477"]
  }
  ssh_username = "ubuntu"
}
```

### 3ï¸âƒ£ Packer build config ì‘ì„±

build ë¶€ë¶„ì—ì„œëŠ” [í™˜ê²½ë³€ìˆ˜ ì„¸íŒ…ì´ë‚˜ ëª…ë ¹ì–´ë¥¼ inline í˜•íƒœ](https://learn.hashicorp.com/tutorials/packer/aws-get-started-provision?in=packer/aws-get-started#add-provisioner-to-template )ë¡œ ê¸°ì… í•  ìˆ˜ ìˆì§€ë§Œ,
ì•„ë˜ì™€ ê°™ì€ ê°„ë‹¨í•œ ê¸°ëŠ¥ë§Œ ìˆ˜í–‰í•˜ë„ë¡ ì½”ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. `hcl` ë¬¸ë²•ì— ë”°ë¼ **sourceë¥¼ ì§€ì •**í•˜ê³ , í”„ë¡œë¹„ì €ë‹ì„ ìœ„í•œ **ê³µê°œí‚¤ì˜ ìœ„ì¹˜ë¥¼ ëª…ì„¸**í•©ë‹ˆë‹¤. `source`ëŠ” ë¡œì»¬ ë¨¸ì‹ , `destination`ì€ ì›ê²© ë¨¸ì‹  ì…ë‹ˆë‹¤.
ë§ˆì§€ë§‰ìœ¼ë¡œ Packerë¡œ ë¹Œë“œí•œ ì´ë¯¸ì§€ì—ì„œ Application Setupì´ ë‹´ê¸´ **scriptë¥¼ ì§€ì •**í•©ë‹ˆë‹¤. 

```shell
build {
  sources = ["source.amazon-ebs.example"]

  provisioner "file" {
    source      = "../tf-packer.pub"
    destination = "/tmp/tf-packer.pub"
  }
  provisioner "shell" {
    script = "../scripts/setup.sh"
  }
}
```

<br>

## 4ï¸âƒ£ Shell script ì‘ì„± 

*í•´ë‹¹ ì‘ì—…ì€ `scripts` í´ë”ì˜ `setup.sh`ì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤.* <br>

ì´ ë¶€ë¶„ì€ Terraformìœ¼ë¡œ í”„ë¡œë¹„ì €ë‹ í•œ ì¸í”„ë¼ë¥¼ ì›¹í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ê¸° ìœ„í•´ ê°„ë‹¨í•œ ìƒ˜í”Œì„ ë„ìš°ëŠ” ì½”ë“œê°€ ë‹´ê²¨ìˆìŠµë‹ˆë‹¤.
ì•„ë˜ Scriptì— í•„ìš”í•œ ì¢…ì†ì„± ì„¤ì¹˜, `terraform`ì„ userì— ì¶”ê°€, ìƒì„±í•œ SSHí‚¤ ì„¤ì¹˜, ìƒ˜í”Œ Go App ì„¤ì¹˜ê°€ ë‹¨ê³„ê°€ ì‘ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

{% gist heuristicwave/3c0d9afefb5e04d7b69700f11918e9a0 %}

1 ~ 4ë‹¨ê³„ë¥¼ ë§ˆì³¤ë‹¤ë©´ `images` í´ë” ìœ„ì¹˜ì— `packer build image.pkr.hcl` ëª…ë ¹ì–´ë¡œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤.

<br>

ì´ë¯¸ì§€ ë¹Œë“œ í›„, ì½˜ì†” **Images** íƒ­ì˜ **AMIs**ì„ í™•ì¸í•˜ë©´ ë¹Œë“œí•œ ì´ë¯¸ì§€ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
ë˜í•œ, ì¸ìŠ¤í„´ìŠ¤ íƒ­ì„ í™•ì¸í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ Base AMIë¥¼ ë§Œë“¤ê¸° ìœ„í•œ Packer Builderì˜ í”ì ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
![Packer_Builder](/assets/built/images/post/packerBuilder.png)
í•´ë‹¹ í™”ë©´ì˜ Instance IDë¥¼ ëˆŒëŸ¬ ì„¤ì •ë“¤ì„ í™•ì¸í•´ë³´ë©´ source ë¸”ë¡ì— ì •ì˜í•œ ê°’ì„ ë°”íƒ•ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

## Terraformìœ¼ë¡œ Packer ì´ë¯¸ì§€ ë°°í¬

*í•´ë‹¹ ì‘ì—…ì€ `instances` í´ë”ì—ì„œ ì§„í–‰í•©ë‹ˆë‹¤.* <br>

### Sample App Infra Code ì‘ì„±í•˜ê¸°

ì•„ë˜ ğŸ›  ì´ëª¨í‹°ì½˜ì„ í´ë¦­í•˜ì—¬ `main.tf`ì™€ `varaiables.tf`ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

<details><summary markdown="span">ğŸ”¨ `main.tf` ğŸ”¨</summary>
<br>

```terraform
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 3.26.0"
    }
  }
  required_version = "~> 1.0.2"
}

provider "aws" {
  region = var.region
}

resource "aws_vpc" "vpc" {
  cidr_block           = var.cidr_vpc
  enable_dns_support   = true
  enable_dns_hostnames = true
}

resource "aws_internet_gateway" "igw" {
  vpc_id = aws_vpc.vpc.id
}

resource "aws_subnet" "subnet_public" {
  vpc_id     = aws_vpc.vpc.id
  cidr_block = var.cidr_subnet
}

resource "aws_route_table" "rtb_public" {
  vpc_id = aws_vpc.vpc.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.igw.id
  }
}

resource "aws_route_table_association" "rta_subnet_public" {
  subnet_id      = aws_subnet.subnet_public.id
  route_table_id = aws_route_table.rtb_public.id
}

resource "aws_security_group" "sg_22_80" {
  name   = "sg_22"
  vpc_id = aws_vpc.vpc.id

  # SSH access from the VPC
  ingress {
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    from_port   = 8080
    to_port     = 8080
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

resource "aws_instance" "web" {
  ami                         = "ami-YOUR-AMI-ID"
  instance_type               = "t2.micro"
  subnet_id                   = aws_subnet.subnet_public.id
  vpc_security_group_ids      = [aws_security_group.sg_22_80.id]
  associate_public_ip_address = true

  tags = {
    Name = "Learn-Packer"
  }
}

output "public_ip" {
  value = aws_instance.web.public_ip
}
```

</details>

<details><summary markdown="span">ğŸ”§ `varaiables.tf` ğŸ”§</summary>
<br>

```terraform
variable "cidr_vpc" {
  description = "CIDR block for the VPC"
  default     = "10.1.0.0/16"
}
variable "cidr_subnet" {
  description = "CIDR block for the subnet"
  default     = "10.1.0.0/24"
}

variable "environment_tag" {
  description = "Environment tag"
  default     = "Learn"
}

variable "region"{
  description = "The region Terraform deploys your instance"
  default     = "us-east-1"
}

```
</details><br>

> ì¸í”„ë¼ ì½”ë“œì— ëŒ€í•œ ì„¤ëª…ì€ ìƒëµí•˜ê² ìŠµë‹ˆë‹¤. <br>
> ì¸í”„ë¼ì— ëŒ€í•œ í…Œë¼í¼ ì½”ë“œê°€ ê¶ê¸ˆí•˜ì‹œë‹¤ë©´ ë‹¤ë¥¸ ê²Œì‹œê¸€ì´ë‚˜ [ì œ í¬ìŠ¤íŒ…](https://heuristicwave.github.io/3Tier )ì„ ì½ì–´ë³´ì„¸ìš”!
 
<br>

### AMI Query í•˜ê¸°

[ë³¸ë¬¸](https://learn.hashicorp.com/tutorials/terraform/packer )ì—ëŠ” ì†Œê°œë˜ì§€ ì•Šì•˜ì§€ë§Œ, Packerì™€ Terraformì˜ í†µí•©ì„ ìœ„í•´ í•„ìê°€ ì‘ì„±í•œ ë¶€ë¶„ì…ë‹ˆë‹¤.
Terraformì˜ `Data Sources`ë¥¼ í™œìš©í•´ ë¹Œë“œëœ AMIë¥¼ Queryí•˜ì—¬ ìƒ˜í”Œ ì•±ì„ í”„ë¡œë¹„ì €ë‹ í•´ë´…ì‹œë‹¤.
ì„ í–‰ ì‘ì—…ì—ì„œ ì§„í–‰í•œ `main.tf` í•˜ë‹¨ì— ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.

```terraform
data "aws_ami_ids" "myami" {
  owners = ["YOUR Account ID"]
  # sort_ascending = true
  
  filter {
    name   = "name"
    values = ["learn-terraform-packer-*"]
  }
}
```

Packerë¡œ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí–ˆìœ¼ë¯€ë¡œ, ami ownerê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!
`owners` ë¶€ë¶„ì— ìì‹ ì˜ ê³„ì • IDë¥¼ ì‘ì„±í•˜ê³  `filter`ì— packer buildë¥¼ í•  ë–„ ì‚¬ìš©í•œ ami_nameì„ value ê°’ìœ¼ë¡œ ë„£ìŠµë‹ˆë‹¤.

> **sort_ascending** default ê°’ì´ false
> 
> sort_ascending = false : listì˜ 0ë²ˆì§¸ ìš”ì†Œê°€ latest <br>
> sort_ascending = true : ë§Œë“¤ì–´ì§„ ìˆœì„œëŒ€ë¡œ ë¦¬ìŠ¤íŠ¸ ìƒì„± (ê°€ì¥ ë¨¼ì € ìƒì„±ëœ amiê°€ 0ë²ˆ)

ì´ì–´ì„œ `main.tf`ì— ì¸ìŠ¤í„´ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•œ ë¶€ë¶„ì˜ `ami = "ami-YOUR-AMI-ID"` ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ ëŒ€ì²´í•©ë‹ˆë‹¤.
`data` ê°ì²´ì— í•„í„°ë§í•œ ê²°ê³¼ ê°’ë“¤ì´ ë¹Œë“œëœ AMIë“¤ì´ ë¦¬ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ë“¤ì–´ê°€ëŠ”ë° **latest** ë²„ì „ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ 0ë²ˆì§¸ ì´ë¯¸ì§€ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
í¸ì˜ìƒ ì‚¬ìš©ëœ ami ë²ˆí˜¸ë¥¼ í„°ë¯¸ë„ì—ì„œ í™•ì¸ í•  ìˆ˜ ìˆë„ë¡ `output`ì— ëŒ€í•œ ì½”ë“œë„ í•¨ê»˜ ì‘ì„±í•©ë‹ˆë‹¤.

```terraform
resource "aws_instance" "web" {
  ami = data.aws_ami_ids.myami.ids[0]   # "ami-YOUR-AMI-ID"
  # Skip Other Config
}

output "my_ami" {
  value = aws_instance.web.ami
}
```

ì½”ë“œë¥¼ ì‘ì„±í•˜ê³  í…Œë¼í¼ ì½”ë“œê°€ ìœ„ì¹˜í•œ í´ë”ì—ì„œ(`instances` í´ë” í•˜ìœ„) ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
`terraform init && terraform apply` ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•´ `yes`ë¥¼ ê¸°ì…í•©ë‹ˆë‹¤. <br>

ëª…ë ¹ì–´ë¡œ ì¸í”„ë¼ ìƒíƒœë¥¼ ì ê²€í•´ ì•„ë˜ì™€ ê°™ë‹¤ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ğŸš€
```shell
$ terraform state list
data.aws_ami_ids.myami
aws_instance.web
aws_internet_gateway.igw
aws_route_table.rtb_public
aws_route_table_association.rta_subnet_public
aws_security_group.sg_22_80
aws_subnet.subnet_public
aws_vpc.vpc
```

> data objectì— ë‹´ê¸´ ì •ë³´ê°€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´? <br>
> `$ terraform state show data.aws_ami_ids.myami.ids`

<br>

## ì¸ìŠ¤í„´ìŠ¤ í™•ì¸í•˜ê¸°

SSHë¥¼ í†µí•´ ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°í•©ë‹ˆë‹¤. <br>
`ssh terraform@$(terraform output -raw public_ip) -i ../tf-packer`

Go ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì„¸ìš”. <br>
`cd go/src/github.com/hashicorp/learn-go-webapp-demo`

ë°ëª¨ ì•±ì„ ì‹¤í–‰í•©ë‹ˆë‹¤. <br>
`go run webapp.go`

ë°°í¬í•œ ì•± í™•ì¸ì„ ìœ„í•´ `terraform output public_ip`ë¡œ ì–»ì€ IPì— 8080 í¬íŠ¸ë¡œ ì ‘ì†í•˜ë©´ ê°„ë‹¨í•œ í…ŒíŠ¸ë¦¬ìŠ¤ ê²Œì„ ì•±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ì¸ìŠ¤í„´ìŠ¤ ë¦¬ì†ŒìŠ¤ íšŒìˆ˜

`terraform destroy` ëª…ë ¹ì–´ë¡œ ìƒê¸° í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•œ ì¸í”„ë¼ë¥¼ ë¦¬ì†ŒìŠ¤ë¥¼ íšŒìˆ˜í•©ë‹ˆë‹¤. Packerë¡œ ì‘ì„±í•œ ì´ë¯¸ì§€ëŠ” íŒŒê´´ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

<br>

ìœ„ì™€ ê°™ì€ ë‹¨ê³„ë“¤ì„ í†µí•´ íŒ¨ì»¤ë¡œ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³  í…Œë¼í¼ê³¼ í†µí•©í•˜ëŠ” ë°©ë²•ì„ í•™ìŠµí•´ë³´ì•˜ìŠµë‹ˆë‹¤.
ì´ë²ˆ í¬ìŠ¤íŒ…ì—ì„œ ë‹¤ë¤˜ë˜ ë‚´ìš©ì€ **Immutable Servers**ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•œ ë°©ë²• ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.
ì˜¤ëŠ˜ í¬ìŠ¤íŒ…ì— ì¶”ê°€ë¡œ **Ansible**ì„ í†µí•©í•œë‹¤ë©´, **Immutable Infrastructure**ë¥¼ êµ¬ì¶•í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

---

{% include terraform.html %}

<br>